{% extends "base.html" %}

{% block title %}Learn Test - {{ test_name }}{% endblock %}

{% block content %}
  <h1 class="my-4">{{ test_name }}</h1>

  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>

    {% for line in processed_content %}
      <p class="line-content">
        {{ line | safe }} 
      </p>
    {% endfor %}

    <button type="submit" class="btn btn-primary">Check Answers</button>
  </form>

  <!-- Translation and pronunciation area -->
  <div id="translation-container" class="mt-4">
    <h5>Selected Word:</h5>
    <p id="translated-word" class="font-weight-bold"></p>
    <button id="hear-pronunciation" class="btn btn-secondary" style="display: none;">
      <i class="fas fa-volume-up"></i> Hear Pronunciation
    </button>
  </div>

{% endblock %}

{% block scripts %}
  {{ super() }}

  <script>
    // Function to handle word selection and translation
    function translateAndPronounce(word) {
    fetch(`/translate?word=${encodeURIComponent(word)}`)
        .then(response => response.json())
        .then(data => {
            // Display translation
            document.getElementById('translated-word').textContent = `${word} - ${data.translation}`;
                        // Show the pronunciation button if pronunciation URL is provided
                        const pronunciationBtn = document.getElementById('hear-pronunciation');
            pronunciationBtn.style.display = 'inline-block';

            pronunciationBtn.onclick = function() {
                // Use a dynamically generated pronunciation URL
                const audio = new Audio(`/tts?text=${encodeURIComponent(word)}&lang=en`);
                audio.play();
            };
        })
        .catch(error => console.error('Error:', error));
}

// Add event listener to each word element
document.querySelectorAll('.word').forEach(function(element) {
    element.addEventListener('click', function() {
        const word = this.textContent.trim();
        translateAndPronounce(word); // Call the translation and pronunciation function
    });
});

    // Function to make words clickable without affecting form inputs
    function makeWordsClickable() {
      document.querySelectorAll('.line-content').forEach(function(paragraph) {
        let html = paragraph.innerHTML;
        
        // Split the text by HTML tags to separate form inputs from the rest of the content
        const textSegments = html.split(/(<input.*?>)/g);
        paragraph.innerHTML = '';  // Clear the content to rebuild it with clickable words

        textSegments.forEach(segment => {
          if (segment.startsWith('<input')) {
            // If it's an input field, append it directly
            paragraph.innerHTML += segment;
          } else {
            // If it's text, split into words and make them clickable
            const words = segment.split(/\s+/);
            words.forEach(word => {
              if (word.trim()) {
                const span = document.createElement('span');
                span.textContent = word;
                span.style.cursor = 'pointer';
                span.className = 'word';
                span.onclick = function() {
                  translateAndPronounce(word.trim());
                };
                paragraph.appendChild(span);
                paragraph.appendChild(document.createTextNode(' '));  // Add space after each word
              }
            });
          }
        });
      });
    }

    // Initialize clickable words after the page loads
    document.addEventListener('DOMContentLoaded', makeWordsClickable);
  </script>
{% endblock %}
