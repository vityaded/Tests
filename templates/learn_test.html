<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% extends "base.html" %}

{% block title %}Learn Test - {{ test_name }}{% endblock %}

{% block content %}
  <h1 class="my-4">{{ test_name }}</h1>

  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>

    {% for line in processed_content %}
      <p class="line-content">
        {{ line | safe }} 
      </p>
    {% endfor %}

    <button type="submit" class="btn btn-primary">Check Answers</button>
  </form>

  <!-- Translation and pronunciation area -->
  <div id="translation-popup" class="mt-4" style="display: none;">
    <p id="translated-word" class="font-weight-bold"></p>
    <button id="hear-pronunciation" class="btn btn-secondary">
      <i class="fas fa-volume-up"></i>
    </button>
  </div>

{% endblock %}

{% block scripts %}
  {{ super() }}

  <script>
    // Function to handle word selection and translation
    function translateAndPronounce(word, event) {
      fetch(`/translate?word=${encodeURIComponent(word)}`)
        .then(response => response.json())
        .then(data => {
          // Display translation in the popup
          document.getElementById('translated-word').textContent = `${word} - ${data.translation}`;

          // Set the position of the popup near the clicked word
          const popup = document.getElementById('translation-popup');
          popup.style.display = 'block';
          popup.style.position = 'absolute';
          popup.style.top = `${event.pageY}px`;
          popup.style.left = `${event.pageX}px`;

          // Play pronunciation
          const pronunciationBtn = document.getElementById('hear-pronunciation');
          pronunciationBtn.onclick = function() {
            const audio = new Audio(`/tts?text=${encodeURIComponent(word)}&lang=en`);
            audio.play();
          };
        })
        .catch(error => console.error('Error:', error));
    }

    // Function to make words clickable
    function makeWordsClickable() {
      document.querySelectorAll('.line-content').forEach(function(paragraph) {
        let html = paragraph.innerHTML;

        // Split text by <input> tags and handle words separately
        const textSegments = html.split(/(<input.*?>)/g);
        paragraph.innerHTML = '';  // Clear the paragraph content

        textSegments.forEach(segment => {
          if (segment.startsWith('<input')) {
            // If it's an input, add it directly
            paragraph.innerHTML += segment;
          } else {
            // Split the text into words and make them clickable
            const words = segment.split(/\s+/);
            words.forEach(word => {
              if (word.trim()) {
                const span = document.createElement('span');
                span.textContent = word;
                span.style.cursor = 'pointer';
                span.className = 'word';
                span.onclick = function(event) {
                  translateAndPronounce(word.trim(), event);
                };
                paragraph.appendChild(span);
                paragraph.appendChild(document.createTextNode(' '));  // Add space after each word
              }
            });
          }
        });
      });
    }

    // Make words clickable when the page is ready
    document.addEventListener('DOMContentLoaded', makeWordsClickable);
  </script>
{% endblock %}
