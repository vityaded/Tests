{% extends "base.html" %}

{% block title %}Learn Test - {{ test_name }}{% endblock %}

{% block content %}
  <h1 class="my-4">{{ test_name }}</h1>

  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

    <div id="test-content">
      {% for line in processed_content %}
        <p>{{ line | safe }}</p> <!-- Initially display raw content -->
      {% endfor %}
    </div>

    <button type="submit" class="btn btn-primary">Check Answers</button>
  </form>

  <!-- Translation and pronunciation area -->
  <div id="translation-container" class="mt-4">
    <h5>Selected Word:</h5>
    <p id="translated-word" class="font-weight-bold"></p>
    <button id="hear-pronunciation" class="btn btn-secondary" style="display: none;">
      <i class="fas fa-volume-up"></i> Hear Pronunciation
    </button>
  </div>
  
{% endblock %}

{% block scripts %}
  {{ super() }}

  <script>
    // Function to split content into words and make them clickable
    function splitIntoWords() {
      const paragraphs = document.querySelectorAll("#test-content p");
      paragraphs.forEach(paragraph => {
        const words = paragraph.innerText.split(" "); // Split into words
        const newHTML = words.map(word => `<span class="word" style="cursor: pointer;">${word}</span>`).join(" ");
        paragraph.innerHTML = newHTML; // Replace the paragraph's content
      });
    }

    // Function to handle word selection and translation
    function translateAndPronounce(word) {
      fetch(`/translate?word=${encodeURIComponent(word)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('translated-word').textContent = `${word} - ${data.translation}`;
          const pronunciationBtn = document.getElementById('hear-pronunciation');
          if (data.pronunciation_url) {
            pronunciationBtn.style.display = 'inline-block';
            pronunciationBtn.onclick = function() {
              const audio = new Audio(data.pronunciation_url);
              audio.play();
            };
          } else {
            pronunciationBtn.style.display = 'none';
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Call the split function once the page is loaded
    window.onload = function() {
      splitIntoWords(); // Split all test content into words

      // Add event listener to each word element
      document.querySelectorAll('.word').forEach(function(element) {
        element.addEventListener('click', function() {
          const word = this.textContent.trim();
          translateAndPronounce(word); // Call the function to translate and play pronunciation
        });
      });
    };
  </script>
{% endblock %}
